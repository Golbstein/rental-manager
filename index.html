<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SkiLuxe New Gudauri</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root { --primary: #2563eb; --bg: #f3f4f6; --card: #ffffff; --text: #1f2937; }
        body { font-family: -apple-system, system-ui, sans-serif; background: var(--bg); color: var(--text); margin: 0; display: flex; height: 100vh; }

        /* Sidebar */
        .sidebar { width: 300px; background: var(--card); padding: 20px; border-right: 1px solid #e5e7eb; display: flex; flex-direction: column; overflow-y: auto; }
        .sidebar h2 { margin-top: 10px; font-size: 1.25rem; text-align: center; color: #111827; }
        .form-group { margin-bottom: 15px; }
        label { display: block; font-size: 0.875rem; font-weight: 500; margin-bottom: 5px; }
        input, select { width: 100%; padding: 8px; border: 1px solid #d1d5db; border-radius: 6px; box-sizing: border-box; }

        button.btn-primary { background: var(--primary); color: white; border: none; padding: 10px; width: 100%; border-radius: 6px; cursor: pointer; font-weight: 600; margin-top: 10px; }
        button.btn-primary:hover { opacity: 0.9; }

        button.btn-danger { background: #fee2e2; color: #ef4444; border: 1px solid #fca5a5; padding: 10px; width: 100%; border-radius: 6px; cursor: pointer; margin-top: 20px; font-size: 0.8rem; }

        /* Logo */
        .logo-container { text-align: center; margin-bottom: 10px; }
        .logo-img { max-width: 80%; height: auto; border-radius: 4px; }

        /* Main Content */
        .main { flex: 1; padding: 30px; overflow-y: auto; }

        /* Header & Filters */
        .top-bar { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .filters { display: flex; gap: 10px; align-items: center; background: white; padding: 10px; border-radius: 8px; box-shadow: 0 1px 2px rgba(0,0,0,0.05); }

        /* KPI Cards */
        .kpi-row { display: grid; grid-template-columns: repeat(4, 1fr); gap: 20px; margin-bottom: 20px; }
        .card { background: var(--card); padding: 20px; border-radius: 8px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); position: relative; }
        .card h3 { margin: 0 0 10px 0; font-size: 0.875rem; color: #6b7280; text-transform: uppercase; letter-spacing: 0.5px; }
        .card .value { font-size: 1.5rem; font-weight: 700; }
        .card.highlight { border: 2px solid #10b981; }
        .apt-tag { position: absolute; top: 20px; right: 20px; font-size: 2rem; opacity: 0.1; font-weight: bold; }

        /* Chart Grid */
        .chart-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 30px; }
        .chart-container { background: var(--card); padding: 20px; border-radius: 8px; height: 350px; display: flex; flex-direction: column; }

        /* Matrix Table */
        .matrix-table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        .matrix-table th, .matrix-table td { padding: 8px; text-align: center; border-bottom: 1px solid #f3f4f6; font-size: 0.9rem; }
        .matrix-table th { background: #f9fafb; font-weight: 600; text-align: left; }
        .matrix-table td:first-child { text-align: left; font-weight: 500; color: #4b5563; }
        .matrix-row:last-child td { border-bottom: none; }

        /* Total Row Style */
        .total-row { background-color: #e5e7eb; font-weight: bold; border-bottom: 2px solid #d1d5db; }

        /* General Table */
        .data-table { width: 100%; border-collapse: collapse; background: var(--card); border-radius: 8px; overflow: hidden; }
        .data-table th, .data-table td { text-align: left; padding: 12px 15px; border-bottom: 1px solid #e5e7eb; }
        .data-table th { background: #f9fafb; font-weight: 600; font-size: 0.875rem; }
        .data-table tr:hover { background: #f9fafb; }
        .delete-btn { color: white; background-color: #ef4444; padding: 4px 8px; border-radius: 4px; cursor: pointer; border: none; font-size: 0.8rem; }
        .delete-btn:hover { background-color: #dc2626; }

        /* Uri Row Highlighting */
        .uri-row { background-color: #f0fdf4; font-weight: bold; }
    </style>
</head>
<body>

    <div class="sidebar">
        <div class="logo-container">
            <img src="logo.png" alt="SkiLuxe Logo" class="logo-img" onerror="this.style.display='none'">
        </div>
        <h2>SkiLuxe New Gudauri</h2>

        <form id="transForm" style="margin-top: 20px;">
            <div class="form-group">
                <label>Date</label>
                <input type="date" id="date" required>
            </div>

            <div class="form-group">
                <label>Type</label>
                <select id="type" onchange="toggleFields()">
                    <option value="Income">Income</option>
                    <option value="Expense">Expense</option>
                    <option value="Payout">Payout to Uri</option>
                </select>
            </div>

            <div id="aptField">
                <div class="form-group">
                    <label>Apartment</label>
                    <select id="apartment">
                        <option value="Loft2-518">Loft2-518</option>
                        <option value="F2-227">F2-227</option>
                        <option value="F2-419">F2-419</option>
                        <option value="Shared">Shared (All 3)</option>
                    </select>
                </div>
            </div>

            <div id="incomeFields">
                <div class="form-group">
                    <label>Platform</label>
                    <select id="platform">
                        <option value="Booking.com" selected>Booking.com</option>
                        <option value="Airbnb">Airbnb</option>
                        <option value="Direct">Direct</option>
                        <option value="Website">Website</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Payment Method</label>
                    <select id="method">
                        <option value="POS" selected>POS Terminal (2.4% Fee)</option>
                        <option value="Online">Online Payment (3% Fee)</option>
                        <option value="Tinkoff">Tinkoff</option>
                        <option value="Bank">Bank Transfer</option>
                        <option value="Cash">Cash</option>
                    </select>
                </div>
            </div>

            <div id="expenseFields" style="display:none;">
                <div class="form-group">
                    <label>Category</label>
                    <select id="category">
                        <option value="Cleaning" selected>Cleaning</option>
                        <option value="Accountant">Accountant</option>
                        <option value="POS Terminal fee">POS Terminal fee</option>
                        <option value="Tax">Tax</option>
                        <option value="Booking.com Fee">Booking.com Fee</option>
                        <option value="Utility">Utility</option>
                        <option value="Electricity">Electricity</option>
                        <option value="Water Fee">Water Fee</option>
                        <option value="Internet">Internet</option>
                        <option value="Repair">Repair</option>
                        <option value="Other">Other</option>
                    </select>
                </div>
            </div>

            <div class="form-group">
                <label>Amount (GEL)</label>
                <input type="number" id="amount" step="0.01" min="0" required>
            </div>
            <div class="form-group">
                <label>Description</label>
                <input type="text" id="desc">
            </div>
            <button type="submit" class="btn-primary">Save Transaction</button>
        </form>

        <div style="margin-top:auto">
            <button onclick="resetData()" class="btn-danger">‚ö†Ô∏è Reset All Data</button>
        </div>
    </div>

    <div class="main">
        <div class="top-bar">
            <h1>üè¢ Dashboard Overview</h1>
            <div class="filters">
                <label>From:</label>
                <input type="date" id="filterStart">
                <label>To:</label>
                <input type="date" id="filterEnd">
                <button class="btn-primary" style="margin:0; width:auto; padding:8px 15px;" onclick="renderDashboard()">Apply Filter</button>
            </div>
        </div>

        <div class="kpi-row">
            <div class="card">
                <h3>Total Gross Revenue</h3>
                <div class="value" id="kpi-gross">0.00 GEL</div>
            </div>
            <div class="card">
                <h3>Op. Expenses</h3>
                <div class="value" id="kpi-expense">0.00 GEL</div>
                <div style="font-size:0.75rem; color:#6b7280; margin-top:5px;">(Excl. Tax)</div>
            </div>
            <div class="card">
                <h3>Taxes Paid</h3>
                <div class="value" id="kpi-tax" style="color: #ef4444;">0.00 GEL</div>
            </div>
            <div class="card highlight">
                <h3>Net Profit</h3>
                <div class="value" id="kpi-net" style="color: #10b981;">0.00 GEL</div>
            </div>
        </div>

        <div class="kpi-row" style="grid-template-columns: repeat(3, 1fr);">
            <div class="card">
                <div class="apt-tag">518</div>
                <h3>Loft2-518 Net</h3>
                <div class="value" id="net-518" style="color:#2563eb">0.00 GEL</div>
                <div style="font-size:0.75rem; color:#6b7280;">(Pre-Tax)</div>
            </div>
            <div class="card">
                <div class="apt-tag">227</div>
                <h3>F2-227 Net</h3>
                <div class="value" id="net-227" style="color:#8b5cf6">0.00 GEL</div>
                <div style="font-size:0.75rem; color:#6b7280;">(Pre-Tax)</div>
            </div>
            <div class="card">
                <div class="apt-tag">419</div>
                <h3>F2-419 Net</h3>
                <div class="value" id="net-419" style="color:#ec4899">0.00 GEL</div>
                <div style="font-size:0.75rem; color:#6b7280;">(Pre-Tax)</div>
            </div>
        </div>

        <div class="chart-grid">
            <div class="chart-container">
                <h3 style="margin:0 0 10px 0; font-size:0.9rem; color:#6b7280;">Net Income Distribution (Pre-Tax)</h3>
                <canvas id="aptChart"></canvas>
            </div>

            <div class="chart-container">
                <h3 style="margin:0 0 10px 0; font-size:0.9rem; color:#6b7280;">Platform Performance (Income)</h3>
                <div style="overflow-y:auto; flex:1;">
                    <table class="matrix-table">
                        <thead>
                            <tr>
                                <th>Platform</th>
                                <th>518</th>
                                <th>227</th>
                                <th>419</th>
                            </tr>
                        </thead>
                        <tbody id="matrixBody"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <div class="chart-grid">
            <div class="chart-container">
                <h3 style="margin:0 0 10px 0; font-size:0.9rem; color:#6b7280;">Uri Share</h3>
                <div style="display:flex; flex-direction:column; justify-content:start; flex:1; overflow-y:auto;">
                     <table class="matrix-table" style="font-size:0.9rem;">
                        <tbody id="uriBody"></tbody>
                    </table>
                </div>
            </div>

            <div class="chart-container">
                <h3 style="margin:0 0 10px 0; font-size:0.9rem; color:#6b7280;">Expense Matrix (Cost per Apt)</h3>
                <div style="overflow-y:auto; flex:1;">
                    <table class="matrix-table">
                        <thead>
                            <tr>
                                <th>Category</th>
                                <th>518</th>
                                <th>227</th>
                                <th>419</th>
                            </tr>
                        </thead>
                        <tbody id="expenseMatrixBody"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <h3>Recent Transactions</h3>
        <table class="data-table">
            <thead>
                <tr>
                    <th>Date</th>
                    <th>Apt</th>
                    <th>Type</th>
                    <th>Detail</th>
                    <th>Amount</th>
                    <th>My Share</th>
                    <th>Action</th>
                </tr>
            </thead>
            <tbody id="tableBody"></tbody>
        </table>
    </div>

    <script>
        // --- CONFIG & STATE ---
        let allTransactions = [];
        const POS_FEE = 0.024;
        const ONLINE_FEE = 0.03;
        const APARTMENTS = ['Loft2-518', 'F2-227', 'F2-419'];
        const PLATFORMS = ['Booking.com', 'Airbnb', 'Direct', 'Website'];
        const CATEGORIES = [
            'Cleaning', 'Accountant', 'POS Terminal fee', 'Tax',
            'Booking.com Fee', 'Utility', 'Electricity', 'Water Fee',
            'Internet', 'Repair', 'Other'
        ];

        // Init Dates
        const today = new Date();
        const firstDay = new Date(today.getFullYear(), 0, 1);

        document.getElementById('date').valueAsDate = today;
        document.getElementById('filterStart').valueAsDate = firstDay;
        document.getElementById('filterEnd').valueAsDate = today;

        function toggleFields() {
            const type = document.getElementById('type').value;
            const isPayout = type === 'Payout';

            document.getElementById('incomeFields').style.display = type === 'Income' ? 'block' : 'none';
            document.getElementById('expenseFields').style.display = type === 'Expense' ? 'block' : 'none';
            document.getElementById('aptField').style.display = isPayout ? 'none' : 'block';
        }

        document.getElementById('category').addEventListener('change', function() {
            const sharedCats = ['Accountant', 'POS Terminal fee', 'Tax'];
            if(sharedCats.includes(this.value)) {
                document.getElementById('apartment').value = 'Shared';
            }
        });

        function calculateMyShare(type, apt, amount, posFee) {
            let effective = type === 'Income' ? (amount - posFee) : -amount;
            return effective; // Always 100%
        }

        function loadData() {
            fetch('/load')
            .then(response => response.json())
            .then(data => {
                allTransactions = data.map(t => {
                    const amt = parseFloat(t.amount);
                    const fee = parseFloat(t.posFee) || 0;
                    // For Payouts, myShare is just the negative amount
                    let correctShare = 0;
                    if(t.type === 'Payout') {
                        correctShare = -amt;
                    } else {
                        correctShare = calculateMyShare(t.type, t.apt, amt, fee);
                    }

                    return {
                        ...t,
                        amount: amt,
                        posFee: fee,
                        myShare: correctShare
                    };
                });
                renderDashboard();
            })
            .catch(err => console.error("Error loading data:", err));
        }

        document.getElementById('transForm').addEventListener('submit', function(e) {
            e.preventDefault();

            const type = document.getElementById('type').value;
            const amount = parseFloat(document.getElementById('amount').value);
            const method = document.getElementById('method').value;

            let apt = document.getElementById('apartment').value;
            let category = document.getElementById('category').value;
            let platform = document.getElementById('platform').value;
            let posFee = 0;
            let myShare = 0;

            if (type === 'Payout') {
                apt = 'Uri';
                category = 'Payout';
                platform = '-';
                myShare = -amount;
            } else {
                category = type === 'Income' ? 'Rent' : category;
                platform = type === 'Income' ? platform : '-';

                if (type === 'Income') {
                    if (method === 'POS') posFee = amount * POS_FEE;
                    else if (method === 'Online') posFee = amount * ONLINE_FEE;
                }
                myShare = calculateMyShare(type, apt, amount, posFee);
            }

            const newTrans = {
                id: Date.now(),
                date: document.getElementById('date').value,
                apt: apt,
                type: type,
                category: category,
                platform: platform,
                method: type === 'Income' ? method : '-',
                desc: document.getElementById('desc').value,
                amount: amount,
                posFee: posFee,
                myShare: myShare
            };

            fetch('/save', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(newTrans)
            }).then(() => {
                allTransactions.push(newTrans);
                renderDashboard();
                this.reset();
                document.getElementById('date').valueAsDate = new Date();
                document.getElementById('method').value = "POS";
                document.getElementById('platform').value = "Booking.com";
                document.getElementById('category').value = "Cleaning";
                toggleFields();
            });
        });

        function deleteTrans(id) {
            if(confirm("Are you sure you want to delete this transaction?")) {
                fetch('/delete', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({id: id})
                }).then(() => {
                    allTransactions = allTransactions.filter(t => t.id != id);
                    renderDashboard();
                });
            }
        }

        function resetData() {
            if(confirm("‚ö†Ô∏è ARE YOU SURE? This will delete ALL data permanently.")) {
                fetch('/reset', { method: 'POST' })
                .then(response => {
                    if(response.ok) {
                        allTransactions = [];
                        renderDashboard();
                        alert("All data has been reset.");
                    }
                });
            }
        }

        function calculateUriStats(transList) {
            let stats = {
                net227: 0,
                net419: 0,
                tax: 0,
                payouts: 0
            };

            transList.forEach(t => {
                // 1. Calculate Net for 227 & 419 (Income - Expenses + SharedExpenses)
                if (t.type === 'Income' || t.type === 'Expense') {
                    // Check Apartment
                    if (t.apt === 'F2-227') stats.net227 += t.myShare;
                    if (t.apt === 'F2-419') stats.net419 += t.myShare;

                    // Handle Shared Expenses split
                    if (t.apt === 'Shared' && t.type === 'Expense') {
                        // Tax is handled separately below
                        if (t.category !== 'Tax') {
                            const split = t.myShare / 3;
                            stats.net227 += split;
                            stats.net419 += split;
                        }
                    }
                }

                // 2. Accumulate Tax
                if (t.type === 'Expense' && t.category === 'Tax') {
                    stats.tax += t.amount;
                }

                // 3. Accumulate Payouts
                if (t.type === 'Payout') {
                    stats.payouts += t.amount;
                }
            });
            return stats;
        }

        function renderDashboard() {
            const startStr = document.getElementById('filterStart').value;
            const endStr = document.getElementById('filterEnd').value;
            const start = new Date(startStr);
            const end = new Date(endStr);
            end.setHours(23, 59, 59);

            const filtered = allTransactions.filter(t => {
                const tDate = new Date(t.date);
                return tDate >= start && tDate <= end;
            });

            // Stats
            let totalGross = 0, totalExp = 0, totalTax = 0, totalNet = 0;
            let aptNet = { 'Loft2-518': 0, 'F2-227': 0, 'F2-419': 0 };

            let incomeMatrix = {};
            PLATFORMS.forEach(p => {
                incomeMatrix[p] = { 'Loft2-518': 0, 'F2-227': 0, 'F2-419': 0 };
            });

            let expenseMatrix = {};
            CATEGORIES.forEach(c => {
                expenseMatrix[c] = { 'Loft2-518': 0, 'F2-227': 0, 'F2-419': 0 };
            });

            filtered.forEach(t => {
                // PAYOUT
                if (t.type === 'Payout') return;

                // INCOME
                if (t.type === 'Income') {
                    totalGross += t.amount;
                    let effective = t.amount - t.posFee;

                    if (incomeMatrix[t.platform] && incomeMatrix[t.platform][t.apt] !== undefined) {
                        incomeMatrix[t.platform][t.apt] += effective;
                    }
                    if(aptNet[t.apt] !== undefined) aptNet[t.apt] += effective;

                    totalNet += t.myShare;
                }

                // EXPENSE
                if (t.type === 'Expense') {
                    // Update Expense Matrix
                    if (t.apt === 'Shared') {
                        const split = Math.abs(t.myShare) / 3;
                        if(expenseMatrix[t.category]) {
                            expenseMatrix[t.category]['Loft2-518'] += split;
                            expenseMatrix[t.category]['F2-227'] += split;
                            expenseMatrix[t.category]['F2-419'] += split;
                        }
                    } else {
                        if(expenseMatrix[t.category] && expenseMatrix[t.category][t.apt] !== undefined) {
                            expenseMatrix[t.category][t.apt] += Math.abs(t.myShare);
                        }
                    }

                    if (t.category === 'Tax') {
                        totalTax += t.amount;
                        totalNet += t.myShare;
                    } else {
                        totalExp += t.amount;
                        totalNet += t.myShare;

                        if (t.apt === 'Shared') {
                            const splitAmount = t.myShare / 3;
                            aptNet['Loft2-518'] += splitAmount;
                            aptNet['F2-227'] += splitAmount;
                            aptNet['F2-419'] += splitAmount;
                        } else {
                            if(aptNet[t.apt] !== undefined) aptNet[t.apt] += t.myShare;
                        }
                    }
                }
            });

            // UI Updates
            document.getElementById('kpi-gross').innerText = `${formatMoney(totalGross)}`;
            document.getElementById('kpi-expense').innerText = `${formatMoney(totalExp)}`;
            document.getElementById('kpi-tax').innerText = `${formatMoney(totalTax)}`;
            document.getElementById('kpi-net').innerText = `${formatMoney(totalNet)}`;

            document.getElementById('net-518').innerText = `${formatMoney(aptNet['Loft2-518'])}`;
            document.getElementById('net-227').innerText = `${formatMoney(aptNet['F2-227'])}`;
            document.getElementById('net-419').innerText = `${formatMoney(aptNet['F2-419'])}`;

            // Render Income Matrix
            const iMatrixBody = document.getElementById('matrixBody');
            iMatrixBody.innerHTML = '';

            // Total Row
            let iTotals = { 'Loft2-518': 0, 'F2-227': 0, 'F2-419': 0 };
            PLATFORMS.forEach(p => {
                iTotals['Loft2-518'] += incomeMatrix[p]['Loft2-518'];
                iTotals['F2-227'] += incomeMatrix[p]['F2-227'];
                iTotals['F2-419'] += incomeMatrix[p]['F2-419'];
            });

            iMatrixBody.innerHTML += `
                <tr class="total-row">
                    <td>Total</td>
                    <td>${formatCompact(iTotals['Loft2-518'])}</td>
                    <td>${formatCompact(iTotals['F2-227'])}</td>
                    <td>${formatCompact(iTotals['F2-419'])}</td>
                </tr>
            `;

            PLATFORMS.forEach(p => {
                const r = incomeMatrix[p];
                iMatrixBody.innerHTML += `
                    <tr class="matrix-row">
                        <td>${p}</td>
                        <td>${formatCompact(r['Loft2-518'])}</td>
                        <td>${formatCompact(r['F2-227'])}</td>
                        <td>${formatCompact(r['F2-419'])}</td>
                    </tr>
                `;
            });

            // Render Expense Matrix
            const eMatrixBody = document.getElementById('expenseMatrixBody');
            eMatrixBody.innerHTML = '';

            // Total Row
            let eTotals = { 'Loft2-518': 0, 'F2-227': 0, 'F2-419': 0 };
            CATEGORIES.forEach(c => {
                eTotals['Loft2-518'] += expenseMatrix[c]['Loft2-518'];
                eTotals['F2-227'] += expenseMatrix[c]['F2-227'];
                eTotals['F2-419'] += expenseMatrix[c]['F2-419'];
            });

            eMatrixBody.innerHTML += `
                <tr class="total-row">
                    <td>Total</td>
                    <td>${formatCompact(eTotals['Loft2-518'])}</td>
                    <td>${formatCompact(eTotals['F2-227'])}</td>
                    <td>${formatCompact(eTotals['F2-419'])}</td>
                </tr>
            `;

            CATEGORIES.forEach(c => {
                const r = expenseMatrix[c];
                const total = r['Loft2-518'] + r['F2-227'] + r['F2-419'];
                if(total > 0.01) {
                    eMatrixBody.innerHTML += `
                        <tr class="matrix-row">
                            <td>${c}</td>
                            <td>${formatCompact(r['Loft2-518'])}</td>
                            <td>${formatCompact(r['F2-227'])}</td>
                            <td>${formatCompact(r['F2-419'])}</td>
                        </tr>
                    `;
                }
            });

            // RENDER URI TABLE (Dual View)
            const uriBody = document.getElementById('uriBody');

            // Current Period
            const curStats = calculateUriStats(filtered);
            const curShare = (curStats.net227 * 0.5) + (curStats.net419 * 0.5) - (curStats.tax / 3);
            const curBalance = curShare - curStats.payouts;

            // All Time
            const allStats = calculateUriStats(allTransactions);
            const allShare = (allStats.net227 * 0.5) + (allStats.net419 * 0.5) - (allStats.tax / 3);
            const allBalance = allShare - allStats.payouts;

            uriBody.innerHTML = `
                <tr class="uri-section-title"><td colspan="2">CURRENT DATE RANGE</td></tr>
                <tr><td>Share Earned (Net - Tax):</td><td style="text-align:right;">${formatMoney(curShare)}</td></tr>
                <tr><td>Paid:</td><td style="text-align:right; color:#ef4444;">-${formatMoney(curStats.payouts)}</td></tr>
                <tr style="border-bottom:2px solid #d1d5db; font-weight:bold;"><td>Balance (This Period):</td><td style="text-align:right;">${formatMoney(curBalance)}</td></tr>

                <tr style="height:15px;"></tr>

                <tr class="uri-section-title"><td colspan="2">ALL TIME HISTORY</td></tr>
                <tr><td>Total Share Earned:</td><td style="text-align:right;">${formatMoney(allShare)}</td></tr>
                <tr><td>Total Paid:</td><td style="text-align:right; color:#ef4444;">-${formatMoney(allStats.payouts)}</td></tr>
                <tr class="uri-row" style="font-size:1.1rem; background:#ecfdf5;">
                    <td>FINAL BALANCE DUE:</td>
                    <td style="text-align:right; color:#047857;">${formatMoney(allBalance)}</td>
                </tr>
            `;

            // Render Transaction Table
            const tbody = document.getElementById('tableBody');
            tbody.innerHTML = '';
            const sorted = [...filtered].sort((a, b) => new Date(b.date) - new Date(a.date));
            sorted.forEach(t => {
                let aptDisplay = t.apt;
                let color = getAptColor(t.apt);

                if(t.type === 'Payout') {
                    aptDisplay = 'Uri Payout';
                    color = '#f59e0b';
                } else if (t.apt === 'Shared') {
                    color = '#6b7280';
                }

                const row = `<tr>
                    <td>${t.date}</td>
                    <td><span style="background:${color}; color:${t.apt==='Shared'?'white':'white'}; padding:2px 6px; border-radius:4px; font-size:0.8rem">${aptDisplay}</span></td>
                    <td>${t.type}</td>
                    <td>${t.desc || t.category} <small style="color:#6b7280">(${t.platform})</small></td>
                    <td>${t.type === 'Expense' || t.type === 'Payout' ? '-' : ''}${formatMoney(t.amount)}</td>
                    <td style="font-weight:bold; color:${t.myShare >= 0 ? '#10b981' : '#ef4444'}">${t.type==='Payout' ? '-' : formatMoney(t.myShare)}</td>
                    <td><button class="delete-btn" onclick="deleteTrans(${t.id})">Delete</button></td>
                </tr>`;
                tbody.innerHTML += row;
            });

            updateChart(aptNet);
        }

        function formatMoney(amount) {
            return amount.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 }) + ' GEL';
        }

        function formatCompact(amount) {
             if(Math.abs(amount) < 0.01) return '<span style="color:#d1d5db">-</span>';
             return Math.round(amount).toLocaleString() + ' <small>GEL</small>';
        }

        let barChart;
        function updateChart(data) {
            const ctxBar = document.getElementById('aptChart');
            if (barChart) barChart.destroy();
            barChart = new Chart(ctxBar, {
                type: 'bar',
                data: {
                    labels: Object.keys(data),
                    datasets: [{
                        label: 'Net Income (Per Apartment)',
                        data: Object.values(data),
                        backgroundColor: ['#2563eb', '#8b5cf6', '#ec4899']
                    }]
                },
                options: { responsive: true, maintainAspectRatio: false }
            });
        }

        function getAptColor(apt) {
            if(apt === 'Loft2-518') return '#2563eb';
            if(apt === 'F2-227') return '#8b5cf6';
            if(apt === 'F2-419') return '#ec4899';
            return '#d1d5db';
        }

        toggleFields();
        loadData();
    </script>
</body>
</html>